{"version":3,"sources":["likes/queuehandler.js"],"names":["JetpackLikesPostMessage","message","target","JSON","parse","e","pm","type","data","origin","JetpackLikesBatchHandler","requests","jQuery","each","jetpackLikesWidgetBatch","indexOf","this","id","jetpackIsScrolledIntoView","push","info","regex","match","exec","length","blog_id","width","post_id","comment_id","obj_id","event","window","frames","JetpackLikesMessageListener","$container","$list","offset","rowLength","height","scrollbarWidth","document","ready","jetpackLikesMasterReady","stylesData","$sdTextColor","$sdLinkColor","adminBarStyles","background","css","isRtl","addEventListener","hide","textStyles","color","fontFamily","fontSize","direction","fontWeight","fontStyle","textDecoration","linkStyles","fadeOut","remove","wpcom_reblog","toggle_reblog_box_flair","find","html","text","total","likers","i","liker","element","profile_URL","substr","addClass","css_class","attr","href","rel","src","avatar_URL","alt","name","paddingRight","append","parent","left","position","top","Math","floor","ceil","fadeIn","offsetWidth","clientWidth","JetpackLikesWidgetQueueHandler","wrapperID","setTimeout","jetpackUnloadScrolledOutWidgets","unloadedWidgetsInView","jetpackGetUnloadedWidgetsInView","jetpackLoadLikeWidgetIframe","$wrapper","placeholder","hasClass","postLikesFrame","createElement","frameBorder","scrolling","after","commentLikesFrame","jetpackCommentLikesLoadedWidgets","removeClass","load","$iframe","Jetpack","filter","getBoundingClientRect","bottom","jetpackLikesLookAhead","innerHeight","currentWidgetIframe","$widgetWrapper","children","splice","bind","click","has","jetpackWidgetsDelayedExec","fn","timer","clearTimeout","jetpackOnScrollStopped"],"mappings":"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","file":"../../likes/queuehandler.min.js","sourcesContent":["/* Do not modify this file directly. It is compiled from other files. */\n/* global pm, wpcom_reblog, JSON */\n\nvar jetpackLikesWidgetBatch = [];\nvar jetpackLikesMasterReady = false;\n\n// Due to performance problems on pages with a large number of widget iframes that need to be loaded,\n// we are limiting the processing at any instant to unloaded widgets that are currently in viewport,\n// plus this constant that will allow processing of widgets above and bellow the current fold.\n// This aim of it is to improve the UX and hide the transition from unloaded to loaded state from users.\nvar jetpackLikesLookAhead = 2000; // pixels\n\n// Keeps track of loaded comment likes widget so we can unload them when they are scrolled out of view.\nvar jetpackCommentLikesLoadedWidgets = [];\n\nfunction JetpackLikesPostMessage(message, target ) {\n\tif ( 'string' === typeof message ){\n\t\ttry {\n\t\t\tmessage = JSON.parse( message );\n\t\t} catch(e) {\n\t\t\treturn;\n\t\t}\n\t}\n\n\tpm( {\n\t\ttarget: target,\n\t\ttype: 'likesMessage',\n\t\tdata: message,\n\t\torigin: '*'\n\t} );\n}\n\nfunction JetpackLikesBatchHandler() {\n\tvar requests = [];\n\tjQuery( 'div.jetpack-likes-widget-unloaded' ).each( function() {\n\t\tif ( jetpackLikesWidgetBatch.indexOf( this.id ) > -1 ) {\n\t\t\treturn;\n\t\t}\n\n\t\tif ( ! jetpackIsScrolledIntoView( this ) ) {\n\t\t\treturn;\n\t\t}\n\n\t\tjetpackLikesWidgetBatch.push( this.id );\n\n\t\tvar regex = /like-(post|comment)-wrapper-(\\d+)-(\\d+)-(\\w+)/,\n\t\t\tmatch = regex.exec( this.id ),\n\t\t\tinfo;\n\n\t\tif ( ! match || match.length !== 5 ) {\n\t\t\treturn;\n\t\t}\n\n\t\tinfo = {\n\t\t\tblog_id: match[2],\n\t\t\twidth:   this.width\n\t\t};\n\n\t\tif ( 'post' === match[1] ) {\n\t\t\tinfo.post_id = match[3];\n\t\t} else if ( 'comment' === match[1] ) {\n\t\t\tinfo.comment_id = match[3];\n\t\t}\n\n\t\tinfo.obj_id = match[4];\n\n\t\trequests.push( info );\n\t});\n\n\tif ( requests.length > 0 ) {\n\t\tJetpackLikesPostMessage( { event: 'initialBatch', requests: requests }, window.frames['likes-master'] );\n\t}\n}\n\nfunction JetpackLikesMessageListener( event, message ) {\n\tvar allowedOrigin, $container, $list, offset, rowLength, height, scrollbarWidth;\n\n\tif ( 'undefined' === typeof event.event ) {\n\t\treturn;\n\t}\n\n\t// We only allow messages from one origin\n\tallowedOrigin = 'https://widgets.wp.com';\n\tif ( allowedOrigin !== message.origin ) {\n\t\treturn;\n\t}\n\n\tswitch ( event.event ) {\n\t\tcase 'masterReady':\n\t\t\tjQuery( document ).ready( function() {\n\t\t\t\tjetpackLikesMasterReady = true;\n\n\t\t\t\tvar stylesData = {\n\t\t\t\t\t\tevent: 'injectStyles'\n\t\t\t\t\t},\n\t\t\t\t\t$sdTextColor = jQuery( '.sd-text-color' ),\n\t\t\t\t\t$sdLinkColor = jQuery( '.sd-link-color' );\n\n\t\t\t\tif ( jQuery( 'iframe.admin-bar-likes-widget' ).length > 0 ) {\n\t\t\t\t\tJetpackLikesPostMessage( { event: 'adminBarEnabled' }, window.frames[ 'likes-master' ] );\n\n\t\t\t\t\tstylesData.adminBarStyles = {\n\t\t\t\t\t\tbackground: jQuery( '#wpadminbar .quicklinks li#wp-admin-bar-wpl-like > a' ).css( 'background' ),\n\t\t\t\t\t\tisRtl: ( 'rtl' === jQuery( '#wpadminbar' ).css( 'direction' ) )\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tif ( ! window.addEventListener ) {\n\t\t\t\t\tjQuery( '#wp-admin-bar-admin-bar-likes-widget' ).hide();\n\t\t\t\t}\n\n\t\t\t\tstylesData.textStyles = {\n\t\t\t\t\tcolor:          $sdTextColor.css( 'color' ),\n\t\t\t\t\tfontFamily:     $sdTextColor.css( 'font-family' ),\n\t\t\t\t\tfontSize:       $sdTextColor.css( 'font-size' ),\n\t\t\t\t\tdirection:      $sdTextColor.css( 'direction' ),\n\t\t\t\t\tfontWeight:     $sdTextColor.css( 'font-weight' ),\n\t\t\t\t\tfontStyle:      $sdTextColor.css( 'font-style' ),\n\t\t\t\t\ttextDecoration: $sdTextColor.css( 'text-decoration' )\n\t\t\t\t};\n\n\t\t\t\tstylesData.linkStyles = {\n\t\t\t\t\tcolor:          $sdLinkColor.css( 'color' ),\n\t\t\t\t\tfontFamily:     $sdLinkColor.css( 'font-family' ),\n\t\t\t\t\tfontSize:       $sdLinkColor.css( 'font-size' ),\n\t\t\t\t\ttextDecoration: $sdLinkColor.css( 'text-decoration' ),\n\t\t\t\t\tfontWeight:     $sdLinkColor.css( 'font-weight' ),\n\t\t\t\t\tfontStyle:      $sdLinkColor.css( 'font-style' )\n\t\t\t\t};\n\n\t\t\t\tJetpackLikesPostMessage( stylesData, window.frames[ 'likes-master' ] );\n\n\t\t\t\tJetpackLikesBatchHandler();\n\t\t\t} );\n\n\t\t\tbreak;\n\n\t\tcase 'showLikeWidget':\n\t\t\tjQuery( '#' + event.id + ' .likes-widget-placeholder' ).fadeOut( 'fast' );\n\t\t\tbreak;\n\n\t\tcase 'showCommentLikeWidget':\n\t\t\tjQuery( '#' + event.id + ' .likes-widget-placeholder' ).fadeOut( 'fast' );\n\t\t\tbreak;\n\n\t\tcase 'killCommentLikes':\n\t\t\t// If kill switch for comment likes is enabled remove all widgets wrappers and `Loading...` placeholders.\n\t\t\tjQuery( '.jetpack-comment-likes-widget-wrapper' ).remove();\n\t\t\tbreak;\n\n\t\tcase 'clickReblogFlair':\n\t\t\twpcom_reblog.toggle_reblog_box_flair( event.obj_id );\n\t\t\tbreak;\n\n\t\tcase 'showOtherGravatars':\n\t\t\t$container = jQuery( '#likes-other-gravatars' );\n\t\t\t$list = $container.find( 'ul' );\n\n\t\t\t$container.hide();\n\t\t\t$list.html( '' );\n\n\t\t\t$container.find( '.likes-text span' ).text( event.total );\n\n\t\t\tjQuery.each( event.likers, function( i, liker ) {\n\t\t\t\tvar element;\n\n\t\t\t\tif ( 'http' !== liker.profile_URL.substr( 0, 4 ) ) {\n\t\t\t\t\t// We only display gravatars with http or https schema\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\telement = jQuery( '<li><a><img /></a></li>' );\n\t\t\t\telement.addClass( liker.css_class );\n\n\t\t\t\telement.find( 'a' ).\n\t\t\t\tattr( {\n\t\t\t\t\thref: liker.profile_URL,\n\t\t\t\t\trel: 'nofollow',\n\t\t\t\t\ttarget: '_parent'\n\t\t\t\t} ).\n\t\t\t\taddClass( 'wpl-liker' );\n\n\t\t\t\telement.find( 'img' ).\n\t\t\t\tattr( {\n\t\t\t\t\tsrc: liker.avatar_URL,\n\t\t\t\t\talt: liker.name\n\t\t\t\t} ).\n\t\t\t\tcss( {\n\t\t\t\t\twidth: '30px',\n\t\t\t\t\theight: '30px',\n\t\t\t\t\tpaddingRight: '3px'\n\t\t\t\t} );\n\n\t\t\t\t$list.append( element );\n\t\t\t} );\n\n\t\t\toffset = jQuery( '[name=\\'' + event.parent + '\\']' ).offset();\n\n\t\t\t$container.css( 'left', offset.left + event.position.left - 10 + 'px' );\n\t\t\t$container.css( 'top', offset.top + event.position.top - 33 + 'px' );\n\n\t\t\trowLength = Math.floor( event.width / 37 );\n\t\t\theight = ( Math.ceil( event.likers.length / rowLength ) * 37 ) + 13;\n\t\t\tif ( height > 204 ) {\n\t\t\t\theight = 204;\n\t\t\t}\n\n\t\t\t$container.css( 'height', height + 'px' );\n\t\t\t$container.css( 'width', rowLength * 37 - 7 + 'px' );\n\n\t\t\t$list.css( 'width', rowLength * 37 + 'px' );\n\n\t\t\t$container.fadeIn( 'slow' );\n\n\t\t\tscrollbarWidth = $list[0].offsetWidth - $list[0].clientWidth;\n\t\t\tif ( scrollbarWidth > 0 ) {\n\t\t\t\t$container.width( $container.width() + scrollbarWidth );\n\t\t\t\t$list.width( $list.width() + scrollbarWidth );\n\t\t\t}\n\t}\n}\n\npm.bind( 'likesMessage', JetpackLikesMessageListener );\n\njQuery( document ).click( function( e ) {\n\tvar $container = jQuery( '#likes-other-gravatars' );\n\n\tif ( $container.has( e.target ).length === 0 ) {\n\t\t$container.fadeOut( 'slow' );\n\t}\n});\n\nfunction JetpackLikesWidgetQueueHandler() {\n\tvar wrapperID;\n\n\tif ( ! jetpackLikesMasterReady ) {\n\t\tsetTimeout( JetpackLikesWidgetQueueHandler, 500 );\n\t\treturn;\n\t}\n\n\t// Restore widgets to initial unloaded state when they are scrolled out of view.\n\tjetpackUnloadScrolledOutWidgets();\n\n\tvar unloadedWidgetsInView = jetpackGetUnloadedWidgetsInView();\n\n\tif ( unloadedWidgetsInView.length > 0 ) {\n\t\t// Grab any unloaded widgets for a batch request\n\t\tJetpackLikesBatchHandler();\n\t}\n\n\tfor ( var i=0, length = unloadedWidgetsInView.length; i <= length - 1; i++ ) {\n\t\twrapperID = unloadedWidgetsInView[i].id;\n\n\t\tif ( ! wrapperID ){\n\t\t\tcontinue;\n\t\t}\n\n\t\tjetpackLoadLikeWidgetIframe( wrapperID );\n\t}\n}\n\nfunction jetpackLoadLikeWidgetIframe( wrapperID ) {\n\tvar $wrapper;\n\t\n\tif ( 'undefined' === typeof wrapperID ) {\n\t\treturn;\n\t}\n\n\t$wrapper = jQuery( '#' + wrapperID );\n\t$wrapper.find( 'iframe' ).remove();\n\n\tvar placeholder = $wrapper.find( '.likes-widget-placeholder' );\n\n\t// Post like iframe\n\tif ( placeholder.hasClass( 'post-likes-widget-placeholder' ) ) {\n\t\tvar postLikesFrame = document.createElement( 'iframe' );\n\n\t\tpostLikesFrame['class'] = 'post-likes-widget jetpack-likes-widget';\n\t\tpostLikesFrame.name = $wrapper.data( 'name' );\n\t\tpostLikesFrame.src = $wrapper.data( 'src' );\n\t\tpostLikesFrame.height = '18px';\n\t\tpostLikesFrame.width = '200px';\n\t\tpostLikesFrame.frameBorder = '0';\n\t\tpostLikesFrame.scrolling = 'no';\n\n\t\tif ( $wrapper.hasClass( 'slim-likes-widget' ) ) {\n\t\t\tpostLikesFrame.height = '22px';\n\t\t\tpostLikesFrame.width = '68px';\n\t\t\tpostLikesFrame.scrolling = 'no';\n\t\t} else {\n\t\t\tpostLikesFrame.height = '55px';\n\t\t\tpostLikesFrame.width = '100%';\n\t\t}\n\n\t\tplaceholder.after( postLikesFrame );\n\t}\n\n\t// Comment like iframe\n\tif ( placeholder.hasClass( 'comment-likes-widget-placeholder' ) ) {\n\t\tvar commentLikesFrame = document.createElement( 'iframe' );\n\n\t\tcommentLikesFrame['class'] = 'comment-likes-widget-frame jetpack-likes-widget-frame';\n\t\tcommentLikesFrame.name = $wrapper.data( 'name' );\n\t\tcommentLikesFrame.src = $wrapper.data( 'src' );\n\t\tcommentLikesFrame.height = '18px';\n\t\tcommentLikesFrame.width = '100%';\n\t\tcommentLikesFrame.frameBorder = '0';\n\t\tcommentLikesFrame.scrolling = 'no';\n\n\t\t$wrapper.find( '.comment-like-feedback' ).after( commentLikesFrame );\n\t\t\n\t\tjetpackCommentLikesLoadedWidgets.push( commentLikesFrame );\n\t}\n\n\t$wrapper.removeClass( 'jetpack-likes-widget-unloaded' ).addClass( 'jetpack-likes-widget-loading' );\n\n\t$wrapper.find( 'iframe' ).load( function( e ) {\n\t\tvar $iframe = jQuery( e.target );\n\n\t\tJetpackLikesPostMessage( { event: 'loadLikeWidget', name: $iframe.attr( 'name' ), width: $iframe.width() }, window.frames[ 'likes-master' ] );\n\n\t\t$wrapper.removeClass( 'jetpack-likes-widget-loading' ).addClass( 'jetpack-likes-widget-loaded' );\n\n\t\tif ( $wrapper.hasClass( 'slim-likes-widget' ) ) {\n\t\t\t$wrapper.find( 'iframe' ).Jetpack( 'resizeable' );\n\t\t}\n\t});\n}\n\nfunction jetpackGetUnloadedWidgetsInView() {\n\tvar $unloadedWidgets = jQuery( 'div.jetpack-likes-widget-unloaded' );\n\n\treturn $unloadedWidgets.filter( function() {\n\t\treturn jetpackIsScrolledIntoView( this );\n\t} );\n}\n\nfunction jetpackIsScrolledIntoView( element ) {\n\tvar top = element.getBoundingClientRect().top;\n\tvar bottom = element.getBoundingClientRect().bottom;\n\n\t// Allow some slack above and bellow the fold with jetpackLikesLookAhead,\n\t// with the aim of hiding the transition from unloaded to loaded widget from users.\n\treturn ( top + jetpackLikesLookAhead >= 0 ) && ( bottom <= window.innerHeight + jetpackLikesLookAhead );\n}\n\nfunction jetpackUnloadScrolledOutWidgets() {\n\tfor ( var i = jetpackCommentLikesLoadedWidgets.length - 1; i >= 0; i-- ) {\n\t\tvar currentWidgetIframe = jetpackCommentLikesLoadedWidgets[ i ];\n\n\t\tif ( ! jetpackIsScrolledIntoView( currentWidgetIframe ) ) {\n\t\t\tvar $widgetWrapper = jQuery( currentWidgetIframe ).parent().parent();\n\n\t\t\t// Restore parent class to 'unloaded' so this widget can be picked up by queue manager again if needed.\n\t\t\t$widgetWrapper\n\t\t\t\t.removeClass( 'jetpack-likes-widget-loaded jetpack-likes-widget-loading' )\n\t\t\t\t.addClass( 'jetpack-likes-widget-unloaded' );\n\n\t\t\t// Bring back the loading placeholder into view.\n\t\t\t$widgetWrapper.children( '.comment-likes-widget-placeholder' ).fadeIn();\n\n\t\t\t// Remove it from the list of loaded widgets.\n\t\t\tjetpackCommentLikesLoadedWidgets.splice( i, 1 );\n\n\t\t\t// Remove comment like widget iFrame.\n\t\t\tjQuery( currentWidgetIframe ).remove();\n\t\t}\n\t}\n}\n\nvar jetpackWidgetsDelayedExec = function( after, fn ) {\n\tvar timer;\n\treturn function() {\n\t\ttimer && clearTimeout( timer );\n\t\ttimer = setTimeout( fn, after );\n\t};\n};\n\nvar jetpackOnScrollStopped = jetpackWidgetsDelayedExec( 250, JetpackLikesWidgetQueueHandler );\n\n// Load initial batch of widgets, prior to any scrolling events.\nJetpackLikesWidgetQueueHandler();\n\n// Add event listener to execute queue handler after scroll.\nwindow.addEventListener( 'scroll', jetpackOnScrollStopped, true );\n"]}