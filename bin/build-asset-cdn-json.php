<?php
/**
 * Builds the manifest for the Asset CDN.
 *
 * @package Jetpack.
 */

// The repo root path.
$repopath = dirname( __DIR__ ) . '/';

// Build an iterator over all files in the repo that match the regex in the RegexIterator.
$directory = new RecursiveDirectoryIterator( $repopath );
$iterator  = new RecursiveIteratorIterator( $directory );
$regex     = new RegexIterator( $iterator, '/^.+\.(css|js)$/i', RecursiveRegexIterator::GET_MATCH );

$ignore_paths = array(
	'_inc/client/',
	'bin/',
	'docker/',
	'docs/',
	'extensions/',
	'logs/',
	'node_modules/',
	'tests/',
	'tools/',
	'vendor/',
	'packages/',
);

$manifest = array();
foreach ( $regex as $path_to_file => $value ) {
	$path_from_repo_root = str_replace( $repopath, '', $path_to_file );

	// Ignore top-level files.
	if ( false === strpos( $path_from_repo_root, '/' ) ) {
		continue;
	}

	// Ignore explicit ignore list.
	foreach ( $ignore_paths as $ignore_path ) {
		if ( 0 === strpos( $path_from_repo_root, $ignore_path ) ) {
			continue 2;
		}
	}

	$manifest[] = $path_from_repo_root;
}

$export = var_export( $manifest, true ); // phpcs:ignore WordPress.PHP.DevelopmentFunctions

file_put_contents( // phpcs:ignore WordPress.WP.AlternativeFunctions
	$repopath . 'modules/photon-cdn/jetpack-manifest.php',
	"<?php
// This file is autogenerated by bin/build-asset-cdn-json.php

\$assets = $export;\r\n"
);
