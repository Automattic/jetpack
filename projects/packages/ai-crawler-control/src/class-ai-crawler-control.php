<?php
/**
 * AI Crawler Control. Control whether AI crawlers should be allowed to index the site's content.
 *
 * @package automattic/jetpack-ai-crawler-control
 */

namespace Automattic\Jetpack;

/**
 * AI Crawler Control tools.
 */
class Ai_Crawler_Control {
	/**
	 * Initializer.
	 * Used to configure the package, eg when called via the Config package.
	 *
	 * @return void
	 */
	public static function init() {
		// Robots.txt additions.
		add_filter( 'robots_txt', array( __CLASS__, 'discourage_crawling' ) );

		/*
		 * ai.txt generation.
		 */
		add_action( 'init', array( __CLASS__, 'generate_rewrite_rules' ) );
		add_filter( 'query_vars', array( __CLASS__, 'add_query_vars' ) );
		add_action( 'parse_request', array( __CLASS__, 'do_ai_txt' ) );
	}

	/**
	 * Add entries to the robots.txt file
	 * to indicate that we do not want AI crawlers from indexing the site's content.
	 *
	 * @since $$next-version$$
	 *
	 * @param string $output The robots.txt output.
	 *
	 * @return string
	 */
	public static function discourage_crawling( $output ) {
		$user_agents = AI_Agents::agent_list();

		$output .= "\n" . '# Jetpack AI Crawler Control tools.' . "\n";
		foreach ( $user_agents as $user_agent ) {
			$output .= sprintf( "User-agent: %s\n", esc_attr( $user_agent ) );
			$output .= "Disallow: /\n";
		}

		return $output;
	}

	/**
	 * Generate rewrite rule for the ai.txt page.
	 *
	 * @since $$next-version$$
	 *
	 * @return void
	 */
	public static function generate_rewrite_rules() {
		add_rewrite_rule( '^ai\\.txt', 'index.php?ai.txt', 'top' );
	}

	/**
	 * Add query vars
	 *
	 * @param array $vars The array of allowed query variable names.
	 *
	 * @return array
	 */
	public static function add_query_vars( $vars ) {
		if ( ! in_array( 'ai.txt', $vars, true ) ) {
			$vars[] = 'ai.txt';
		}

		return $vars;
	}

	/**
	 * Build an ai.txt file,
	 * listing file extensions that should not be indexed by AI crawlers.
	 * This is built using Spawning AI.
	 * https://site.spawning.ai/spawning-ai-txt
	 *
	 * @since $$next-version$$
	 *
	 * @param \WP $wp WordPress request context.
	 *
	 * @return void
	 */
	public static function do_ai_txt( $wp ) {
		// Only proceed if this is a request for ai.txt.
		if ( ! array_key_exists( 'ai.txt', $wp->query_vars ) ) {
			return;
		}

		$file_extensions = static::get_file_extensions();

		header( 'Content-Type: text/plain; charset=utf-8' );

		$output  = "# Jetpack AI Crawler Control tools.\n";
		$output .= "# This file is generated by the Jetpack plugin.\n";
		$output .= "# This list was created via Spawning AI.\n\n";
		$output .= "User-Agent: *\n";

		foreach ( $file_extensions as $extension ) {
			$extension = esc_attr( $extension );

			$output .= "Disallow: *.{$extension}\n";
		}

		$output .= "Disallow: /\n";
		$output .= "Disallow: *\n";

		/**
		 * Filters the ai.txt output.
		 *
		 * @since $$next-version$$
		 *
		 * @param string $output          The ai.txt output.
		 * @param array  $file_extensions List of extensions that we do not want to be crawled by AI agents.
		 */
		echo apply_filters( 'jetpack_ai_control_ai_txt', $output, $file_extensions ); // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped
	}

	/**
	 * Get a list of extensions that we do not want to be crawled by AI agents.
	 *
	 * @since $$next-version$$
	 *
	 * @return array
	 */
	public static function get_file_extensions() {
		$extension_list = array(
			'txt',
			'pdf',
			'doc',
			'docx',
			'odt',
			'rtf',
			'tex',
			'wks',
			'wpd',
			'wps',
			'html',
			'bmp',
			'gif',
			'ico',
			'jpeg',
			'jpg',
			'png',
			'svg',
			'tif',
			'tiff',
			'webp',
			'aac',
			'aiff',
			'amr',
			'flac',
			'm4a',
			'mp3',
			'oga',
			'opus',
			'wav',
			'wma',
			'mp4',
			'webm',
			'ogg',
			'avi',
			'mov',
			'wmv',
			'flv',
			'mkv',
			'py',
			'js',
			'java',
			'c',
			'cpp',
			'cs',
			'h',
			'css',
			'php',
			'swift',
			'go',
			'rb',
			'pl',
			'sh',
			'sql',
		);

		/**
		 * Filter the list of file extensions that should not be crawled by AI agents.
		 *
		 * @since $$next-version$$
		 *
		 * @param array $extension_list List of file extensions.
		 */
		return apply_filters( 'jetpack_ai_control_file_extensions', $extension_list );
	}
}
