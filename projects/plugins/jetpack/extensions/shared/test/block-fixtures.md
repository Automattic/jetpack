# Block test fixtures

## Introduction

Block fixture are used to test the block parsing and serialization logic.

Each test is made up of four (or five) fixture files:

1. `fixture-name.html`: The initial post content.
2. `fixture-name.parsed.json`: The **expected** output of the PEG parser for
   this content (checked against the **actual** output of both the JS and PHP
   versions of the parser).
3. `fixture-name.json`: The **expected** representation of the block(s) inside
   the post content, along with their attributes and any nested content. The
   contents of this file are compared against the **actual** block object(s).
4. `fixture-name.serialized.html`: The **expected** result of calling
   `serialize` on the parsed block object(s). The contents of this file are
   compared against the **actual** re-serialized post content. This final step
   simulates opening and re-saving a post.
5. `fixture-name.server-rendered.html` (optional): The **expected** result of calling
   `render_block` in PHP on the parsed serialized markup from post content. The contents of
   this file are compared against the **actual** server rendered markup. This step
   simulates server-rendering saved post content, so is only needed for dynamic blocks.

Every block is required to have at least one such set of fixture files to test
the parsing and serialization of that block. Additionally, each deprecation for
a block should also have a fixture.

These fixtures must be named like
`jetpack__blockname{__*,}.{html,json,parsed.json,serialized.html,server-rendered.html}`. For example, for the
`jetpack/whatsapp-button` block, the following fixture files must exist:

1. `jetpack__whatsapp-button.html` (or `jetpack__whatsapp-button__specific-test-name.html`). Must
   contain a `<!-- wp:core/image -->` block.
2. `jetpack__whatsapp-button__image.parsed.json` (or `core__image__specific-test-name.parsed.json`).
3. `jetpack__whatsapp-button.json` (or `jetpack__whatsapp-button__specific-test-name.json`).
4. `jetpack__whatsapp-button.serialized.html` (or
   `jetpack__whatsapp-button__specific-test-name.serialized.html`).
5. (optional) `jetpack__whatsapp-button.server-rendered.html` (or
   `jetpack__whatsapp-button__specific-test-name.server-rendered.html`).

It is useful to understand what each of the above files represents:

1. The `.html` file seeds the fixture generation. It is either the current block markup, or the old deprecated markup for the block that needs to be brought up-to-date.
2. The `.parsed.json` file is generated by passing the .html seed file through a parser. It will contain the attributes and innerHtml of the block. In the case of deprecations the attributes will be original ones prior to any migration of attributes in the deprecation process.
3. The `.json` contains the updated attributes and inner blocks after the deprecation process. These are then passed through the current block save method to see if a valid block is produced. The isValid property in this file should be true, and an error will be thrown if not as this indicates that the fixture `.html` file combined with any relevant deprecations is not creating valid block content.
4. The final `.serialized.html` file is generated by the latest block version's save method using the JSON attributes etc from the previous step. This markup should match whatever we would get in the post editor using the attributes from step #3.
5. The optional `.server-rendered.html` file is generated by PHP tests by retrieving the saved post content from the `.serialized.html` fixture, then parsing that markup via `parse_blocks`, and then using the dynamic blocks' render callback via the server-side `render_block` function. This markup should match the block markup that would be delivered to an end user visiting the site.

For each deprecation a fixture should exist with the filename format
`jetpack__whatsapp-button__deprecated-1.html`, with the number relating to the deprecation version.

Ideally all important attributes and features of the block should be tested
this way, for example with a gallery block where adding a  `linkTo` attribute may significantly change the saved content of the block there might be a fixture that has the image tag wrapped in a `<a>` and named `jetpack__tiled-gallery__link-to-attachment.html`.

## Creating fixtures

When adding a new fixtures, only the first file above (1, e.g. `core__image.html`) needs
to be created manually, the other files are generated from this first file.

To create the first file:

1. Create a file with the correct name in this folder.
2. Add the block to an new post in the editor.
3. Toggle the block attributes to desired settings for the test.
4. Switch to the code editor view and copy the block markup.
5. Paste the markup into the file you created at step 1.

Next, to generate files (2) through (4) run the following command from the root of the
jetpack plugin project:

For a single block:

```sh
pnpm fixtures:generate `path\to\block\test\validate.js`
```

For all blocks:

```sh
pnpm fixtures:generate
```

When using this command, please be sure to manually verify that the
contents of the `.json` and `.serialized.html` files are as expected.

In particular, check that the `isValid` property is `true`, and that
the attributes are serialized correctly.

## Add a deprecation fixture

When adding a fixture for a block deprecation follow the same steps as above but name the new fixture file as `core__image__deprecated-1.html`) where the number at the end represents the deprecation version. The content of this file should match the saved block content of the deprecated version of the block.

In the case of deprecations, the content of the `.json` and `.serialized.html` files should match the content produced by the latest version of the block save method, ie. they should mimic what would happen to a block's content when a deprecated version is loaded in the editor and migrated to be compatible with the new save method.

## Updating fixtures

The process for updating fixtures for existing tests is similar to that for creating them:

Run the command to regenerate the files:

For a single block:

```sh
pnpm fixtures:regenerate `path\to\block\test\validate.js`
```

For all blocks:

```sh
pnpm fixtures:regenerate
```

After regenerating fixtures, check that the content of the `.parsed.json` and `.serialized.html` files are as expected. An error should be thrown if any of the fixtures are invalid after parsing.

## Running the tests

The fixture tests will be run as part of running the `fixtures:generate` and `fixtures:regenerate` scripts and also as part of the `pnpm test-extensions` test run. They can also be run independently with `pnpm fixtures:test`

## Fixtures for server rendered blocks

For dynamic blocks that are rendered on the server, we can test an additional set of fixtures representing the server-rendered output of the block. To add additional server-rendered fixtures, add a test for your block to the block extensions suite under the PHP tests directory, and inherit from the [Jetpack_Block_Fixture_TestCase](../../../tests/php/extensions/blocks/class-block-fixture-testcase.php) class.

The provided `generate_server_side_rendering_based_on_serialized_fixtures` method will look for existing fixtures with the `.serialized.html` extension, then parse the block markup, and render the parsed blocks via the server-side `render_block` function. The output of server-rendering those blocks will then be saved to the fixtures directory with a default extension of `.server-rendered.html`. The extension can be overridden to enable testing multiple kinds of server-rendered output. See the test for the [Repeat Visitor block](../../../tests/php/extensions/blocks/test-repeat-visitor.php) for an example.

To run (or generate) server-rendered fixture tests:

```sh
jetpack docker phpunit -- --testsuite=extensions
```

To regenerate server-rendered fixtures, delete the fixtures with the `.server-rendered.html` extension and re-run the above command. The tests will fail, and report that the fixtures have been generated. Re-run the command again, and the tests should pass. Be sure to commit any updated or generated fixtures.

## Related

See the
[`validate.js`](../../blocks/send-a-message/whatsapp-button/test/validate.js)
for an example of how to run these validations against a block.
