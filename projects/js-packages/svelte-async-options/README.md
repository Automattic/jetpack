# Async Options for Svelte

Async Options is a library that provides APIs in both in WordPress and Svelte to make passing data seamless between the WordPress backend and the Svelte frontend.

Async Options differ from regular options in that they must be explicitly registered using the Async Option Registry.

Having a streamlined way to register these options allows us to:

- Have a clear understanding about what options are available
- Ensure that any necessary transformation/validation/sanitization actions are performed at predictable times
- Provide a structured way to pass the option data to the frontend on page load
- Automatically generate REST API CRUD endpoints that can be used by the Svelte front-end
- Automatically set-up a nonce for every option that is registered
- Have typed Svelte options stores that automatically sync with WordPress Options

This package is used in combination with the `@jetpack/packages/async-options` package.


## Usage


#### Step 1: Register the option in Svelte
The option is passed to the front-end via `window.widget_plugin` global variables.

[Zod](https://zod.dev) is used to ensure that the values are properly typed and match the expectations:

```ts
const Widget_Options = z.object({
	// This is required for all Async_Options instances.
	rest_api: z.object({
		value: z.string().url(),
		nonce: z.string(),
	}),

	// This is the template that all Async Options should follow:
	// Each Async Option that's registered is going to be an object with two keys:
	// - `value`: The value of the option
	// - `nonce`: The nonce for the option
	widget_status: z.object({
		// We're the value of status to be a boolean, Zod allows us to declare that trigger an error if the value doesn't match our expectation.
		value: z.boolean(),

		// Nonce is always a string and is automatically generated by in the Endpoint PHP Class.
		nonce: z.string(),
	}),
});

// window.widget_plugin is the variable, but it's unsafe to read
// This is a helper function that's going to use Widget_Options Zod type to extract the values from the window object and validate them.
const async = createAsyncFactory("widget_plugin", Widget_Options);

// This is going to set-up a Svelte store that's going to automatically sync back with WordPress any time the value of the option changes.
export const widgetStatus = async.createStore("widget_status");
```

And that's it, now `widgetStatus` is a fully typed store that's going to automatically sync with WordPress.

#### Step 4: Use the store in components

Registering an async option using `async.createStore()` will create a store with two reactive values:

- value: The value of the option. This will dispatch POST requests to the REST API endpoint when the value changes.
- pending: Whether the value is being currently being sent to the server

Here's a simple version of how that would work:

```svelte
<script type="ts">
	import { widgetStatus } from "./widget-options.ts";
	status = widgetStatus.value;
	pending = widgetStatus.pending;
</script>

{#if $pending}
	 ðŸŒŠ I'm updating the value
{/if}

<input type="checkbox" bind:checked={$status} /> Enable Widget
```

There's now a fully type safe stores that automatically sync front-end and back-end, and will deal deal with sanitization, validation, transformation, nonces, REST API.

To summarize:

1. Create an Async Option Template based class in PHP
2. Register the option in using the Registry class
3. Tell TypeScript what the shape of the global variable looks like
4. Register the zod-validated store in Svelte
5. Create async stores and use them like normal svelte stores


## Security

Need to report a security vulnerability? Go to [https://automattic.com/security/](https://automattic.com/security/) or directly to our security bug bounty site [https://hackerone.com/automattic](https://hackerone.com/automattic).

## License

Svelte Async Options is licensed under [GNU General Public License v2 (or later)](./LICENSE.txt)

