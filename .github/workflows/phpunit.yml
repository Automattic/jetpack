name: PHPUnit tests

on: pull_request

env:
  WP_TRAVISCI: "phpunit"
  COMPOSER_ROOT_VERSION: "dev-master"

jobs:
  phpunit:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ["5.6", "7.0", "7.2", "7.3", "7.4snapshot"]
        wp: ["master", "latest", "previous"]
        name: [ "PHP: ${{ matrix.php }} WP: ${{ matrix.wp }}" ]
        exclude:
        # excludes node 4 on macOS
        - php: "7.0"
        - php: "7.2"
        - wp: "latest"
        include:
         - php: "7.0"
           wp: "latest"
           name: "Just testing"
           legacy-sync: 1

    steps:
      - run: |
          echo 'TEST'
          echo ${{ matrix.env }}
          echo ${{ matrix.env.LEGACY_FULL_SYNC }}

      - uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer, phpunit:v7
          extensions: mysql, imagick
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: |
          echo "::set-output name=dir::$(composer config cache-files-dir)"
      - name: Composer cache
        uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Tool versions
        run: |
          php --version
          composer --version

      - name: Setup and run tests
        env:
          WP_BRANCH: ${{ matrix.wp }}
          TRAVIS_PHP_VERSION: ${{ matrix.php }}
          LEGACY_FULL_SYNC: ${{ matrix.legacy-sync }}
        run: |
          sudo systemctl start mysql.service
          export PLUGIN_SLUG=$(basename $(pwd))
          export PATH="$HOME/.config/composer/vendor/bin:$HOME/.composer/vendor/bin:$PATH"
          ./tests/setup-travis.sh
          ./tests/run-travis.sh
