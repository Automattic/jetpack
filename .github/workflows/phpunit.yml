name: PHPUnit tests

on: pull_request

env:
  WP_TRAVISCI: "phpunit"
  COMPOSER_ROOT_VERSION: "dev-master"

jobs:
  phpunit:
    name: "PHP: ${{ matrix.php }} WP: ${{ matrix.wp }}"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ["5.6", "7.0", "7.2", "7.3", "7.4snapshot"]
        wp: ["master", "latest", "previous"]
        exclude:
        # excludes node 4 on macOS
        - php: "7.0"
        - php: "7.2"
        - wp: "latest"
        include:
         - php: "7.0"
           wp: "latest"
           env:
            LEGACY_FULL_SYNC: 1


  # - php: "7.0"
  #   name: "Legacy full sync"
  #   env: LEGACY_FULL_SYNC=1 WP_BRANCH=latest


  # - WP_BRANCH=master SIMPLE_AND_MULTISITE=1 # SIMPLE_AND_MULTISITE is just a way to explicitly mention that we run both suites
  # - WP_BRANCH=latest
  # - WP_BRANCH=previous PHP_LINT=1
# env:
#   global:
#   # Global variable is re-defined in matrix-include -list
#   - WP_TRAVISCI=phpunit
#   # Tell Composer that the version is "dev-master" to avoid it guessing for the monorepo packages.
#   - COMPOSER_ROOT_VERSION=dev-master
#   # Run phpunit in Travis matrix for these combinations

    steps:
      - run: |
          echo 'TEST'
          echo ${{ matrix.env }}
          echo ${{ matrix.env.LEGACY_FULL_SYNC }}

      - uses: actions/checkout@v2

      - name: Setup PHP and remove shared extension
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer, phpunit:v7
          extensions: mysql, imagick
          coverage: none

      - name: Get Composer cache directory
        id: composer-cache
        run: |
          echo "::set-output name=dir::$(composer config cache-files-dir)"
      - name: Composer cache
        uses: actions/cache@v2
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Tool versions
        run: |
          php --version
          composer --version

      - name: Setup and run tests
        env:
          WP_BRANCH: ${{ matrix.wp }}
          TRAVIS_PHP_VERSION: ${{ matrix.php }}
        run: |
          sudo systemctl start mysql.service
          export PLUGIN_SLUG=$(basename $(pwd))
          export PATH="$HOME/.config/composer/vendor/bin:$HOME/.composer/vendor/bin:$PATH"
          ./tests/setup-travis.sh
          ./tests/run-travis.sh
