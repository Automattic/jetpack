name: Jetpack block performance

on:
  pull_request:
    paths-ignore:
    - '**.md'
  push:
    branches: [master]
    paths-ignore:
    - '**.md'
  schedule:
    - cron:  '0 */12 * * *'

jobs:
  block-performance:
    name: "Performance tests"
    runs-on: ubuntu-latest
    timeout-minutes: 25  # 2021-04-16: Successful runs seem to take 11-17 minutes

    steps:
    - uses: actions/checkout@v2

    - name: Setup tools
      uses: ./.github/actions/tool-setup
      with:
        node: 14

    - uses: actions/checkout@v2
      with:
        repository: 'WordPress/gutenberg'
        path: 'gutenberg'

    - name: Build Gutenberg
      working-directory: gutenberg
      run: |
        npm ci
        npm run build

    - name: Build Production Jetpack
      run: |
        pnpm install
        pnpx jetpack build plugins/jetpack -v --production

    - name: Environment set-up
      working-directory: tools/e2e-commons
      env:
        CONFIG_KEY: ${{ secrets.E2E_CONFIG_KEY }}
      run: |
        pnpm install
        pnpm config:decrypt
        echo "    gutenberg/packages/e2e-tests/plugins/disable-animations.php: /var/www/html/wp-content/plugins/disable-animations.php" >> ../docker/jetpack-docker-config-default.yml
        pnpm env:start
        pnpm tunnel:on
        pnpm jetpack-connect
        pnpx jetpack docker --type e2e --name t1 wp jetpack module deactivate sso

    - name: Run performance test
      working-directory: gutenberg
      run: |
        export TUNNEL_URL=$(cat ../tools/e2e-commons/config/tmp/e2e-tunnels.txt)
        # We use || to get away from some random request failures which does not affect the results but generating non-zero exit code.
        WP_BASE_URL=$TUNNEL_URL WP_USERNAME=wordpress WP_PASSWORD=wordpress npm run test-performance packages/e2e-tests/specs/performance/post-editor.test.js || true

    - name: Environment tear-down
      if: ${{ always() }}
      working-directory: tools/e2e-commons
      continue-on-error: true
      run: |
        pnpm run tunnel-off

    - name: Upload test artifacts
      if: ${{ always() }}
      continue-on-error: true
      uses: actions/upload-artifact@v2
      with:
        name: test-output-block-perf
        path: gutenberg/packages/e2e-tests/specs/performance/post-editor.test.results.json

  test-reports:
    name: "Trigger test report workflow"
    runs-on: ubuntu-latest
    if: ${{ ! cancelled() }}
    needs: block-performance

    steps:
      - name: Repository Dispatch
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.E2E_TEST_REPORTS_TOKEN }}
          repository: automattic/jetpack-e2e-reports
          event-type: block-perf
          client-payload: '{"run_id": "${{github.run_id}}", "repository": "${{github.repository}}"}'
