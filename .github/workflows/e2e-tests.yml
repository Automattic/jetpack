name: Jetpack E2E Tests

on:
  pull_request:
    paths-ignore:
    - '**.md'
  push:
    branches: [master]
    paths-ignore:
    - '**.md'

concurrency:
  group: e2e-tests-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-matrix:
    name: "Determine tests matrix"
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      matrix: ${{ steps.create-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v2
      - id: create-matrix
        run: |
          PROJECTS='[{"project":"jetpack","path":"projects/plugins/jetpack/tests/e2e"},{"project":"boost","path":"projects/plugins/boost/tests/e2e"}]'
          echo $PROJECTS

          # should check changed files here and decide which project should run

          echo "::set-output name=matrix::$PROJECTS"

  e2e-tests:
    name: "E2E ${{ matrix.project }} tests"
    runs-on: ubuntu-latest
    needs: create-matrix
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson( needs.create-matrix.outputs.matrix ) }}
    env:
      PROJECT: ${{ matrix }}
    if: github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name

    steps:
    - uses: actions/checkout@v2

    - name: Setup tools
      uses: ./.github/actions/tool-setup

    - name: Install monorepo
      run: |
        pnpm install

    - name: Build plugins
      working-directory: ${{ matrix.path }}
      run: |
        echo "::group::Build Jetpack"
        pnpx jetpack build plugins/jetpack -v --production
        echo "::endgroup::"

        echo "::group::Build plugin"
        pnpm run build:plugin
        echo "::endgroup::"

    - name: Test environment set-up
      working-directory: ${{ matrix.path }}
      env:
        CONFIG_KEY: ${{ secrets.E2E_CONFIG_KEY }}
      run: |
        echo "::group::Install e2e project"
        pnpm install
        echo "::endgroup::"

        echo "::group::Decrypt config"
        pnpm run config:decrypt
        echo "::endgroup::"

        echo "::group::Start docker environment"
        pnpm run env:up
        echo "::endgroup::"

        echo "::group::Create tunnel"
        pnpm run tunnel:up
        echo "::endgroup::"

    - name: Run ${{ matrix.project }} tests
      working-directory: ${{ matrix.path }}
      run: pnpm run test:run

    - name: Test environment tear-down
      if: ${{ always() }}
      working-directory: ${{ matrix.path }}
      continue-on-error: true
      run: |
        pnpm run tunnel:down

    - name: Upload test artifacts
      if: ${{ always() }}
      continue-on-error: true
      uses: actions/upload-artifact@v2
      with:
        name: test-output-${{ matrix.group }}
        path: projects/plugins/jetpack/tests/e2e/output

    - name: Send Slack notification
      if: ${{ failure() }}
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      working-directory: projects/plugins/jetpack/tests/e2e
      run: pnpm run slack -- suite $GROUP
